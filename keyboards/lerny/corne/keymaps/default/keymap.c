#include QMK_KEYBOARD_H

#include "features/achordion.h"

enum {
    _BASE,
    _NAV,
    _NUM,
    _SYM,
    _FUN,
    _MEDIA,
    _MOUSE,
    _GAME,
    _GAME_NUM,
    _GAME_FUN
};

enum {
    ESC_TAB,
    DT_BOOT,
};

#define HOME_N LGUI_T(KC_N)
#define HOME_R LALT_T(KC_R)
#define HOME_T LCTL_T(KC_T)
#define HOME_S LSFT_T(KC_S)

#define HOME_I LGUI_T(KC_I)
#define HOME_E LALT_T(KC_E)
#define HOME_A LCTL_T(KC_A)
#define HOME_H LSFT_T(KC_H)

#define ESC_MEDIA LT(_MEDIA, KC_ESC)
#define SPC_NAV LT(_NAV, KC_SPC)
#define TAB_MOUSE LT(_MOUSE, KC_TAB)
#define ENT_SYM LT(_SYM, KC_ENT)
#define BSPC_NUM LT(_NUM, KC_BSPC)
#define DEL_FUN LT(_FUN, KC_DEL)

#define LEFT_WS LGUI(LCTL(KC_LEFT))
#define RIGHT_WS LGUI(LCTL(KC_RIGHT))

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
    [_BASE] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
              RIGHT_WS,         KC_B,         KC_L,         KC_D,         KC_W,         KC_Z,                                     KC_QUOT,         KC_F,         KC_O,         KC_U,         KC_J,      KC_LBRC,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               LEFT_WS,       HOME_N,       HOME_R,       HOME_T,       HOME_S,         KC_G,                                        KC_Y,       HOME_H,       HOME_A,       HOME_E,       HOME_I,      KC_SCLN,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,         KC_Q,         KC_X,         KC_M,         KC_C,         KC_V,                                        KC_K,         KC_P,      KC_SLSH,      KC_COMM,       KC_DOT,      KC_RBRC,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                     ESC_MEDIA,      SPC_NAV,    TAB_MOUSE,         ENT_SYM,     BSPC_NUM,      DEL_FUN
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    ),

    [_NAV] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,  TD(DT_BOOT),      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,                                     C(KC_Y),      C(KC_V),      C(KC_C),      C(KC_X),      C(KC_Z),      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      KC_LGUI,      KC_LALT,      KC_LCTL,      KC_LSFT,       KC_SPC,                                     CW_TOGG,      KC_LEFT,      KC_DOWN,        KC_UP,      KC_RGHT,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      XXXXXXX,      KC_RALT,      XXXXXXX,      XXXXXXX,      XXXXXXX,                                   KC_INSERT,      KC_HOME,      KC_PGDN,      KC_PGUP,       KC_END,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                       XXXXXXX,      XXXXXXX,      XXXXXXX,          KC_ENT,      KC_BSPC,       KC_DEL
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    ),

    [_NUM] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      KC_LBRC,         KC_7,         KC_8,         KC_9,      KC_RBRC,                                     XXXXXXX,    TG(_GAME),      XXXXXXX,      XXXXXXX,  TD(DT_BOOT),      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      KC_SCLN,         KC_4,         KC_5,         KC_6,       KC_EQL,                                     XXXXXXX,      KC_LSFT,      KC_LCTL,      KC_LALT,      KC_LGUI,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,       KC_GRV,         KC_1,         KC_2,         KC_3,      KC_BSLS,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      KC_RALT,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                        KC_DOT,         KC_0,      KC_MINS,         XXXXXXX,      XXXXXXX,      XXXXXXX
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    ),

    [_SYM] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      KC_LCBR,      KC_AMPR,      KC_ASTR,      KC_LPRN,      KC_RCBR,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      KC_COLN,       KC_DLR,      KC_PERC,      KC_CIRC,      KC_PLUS,                                     XXXXXXX,      KC_LSFT,      KC_LCTL,      KC_LALT,      KC_LGUI,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      KC_TILD,      KC_EXLM,        KC_AT,      KC_HASH,      KC_PIPE,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      KC_RALT,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                       KC_LPRN,      KC_RPRN,      KC_UNDS,         XXXXXXX,      XXXXXXX,      XXXXXXX
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    ),

    [_FUN] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,       KC_F12,        KC_F7,        KC_F8,        KC_F9,      KC_PSCR,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,       KC_F11,        KC_F4,        KC_F5,        KC_F6,      KC_SCRL,                                     XXXXXXX,      KC_LSFT,      KC_LCTL,      KC_LALT,      KC_LGUI,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,       KC_F10,        KC_F1,        KC_F2,        KC_F3,       KC_BRK,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      KC_RALT,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                        KC_APP,       KC_SPC,       KC_TAB,         XXXXXXX,      XXXXXXX,      XXXXXXX
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    ),

    [_MEDIA] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      KC_LGUI,      KC_LALT,      KC_LCTL,      KC_LSFT,      XXXXXXX,                                     XXXXXXX,      KC_MPRV,      KC_VOLD,      KC_VOLU,      KC_MNXT,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      XXXXXXX,      KC_RALT,      XXXXXXX,      XXXXXXX,      XXXXXXX,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                       XXXXXXX,      XXXXXXX,      XXXXXXX,         KC_MPLY,      KC_MSTP,      KC_MUTE
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    ),

    [_MOUSE] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,                                     C(KC_Y),      C(KC_V),      C(KC_C),      C(KC_X),      C(KC_Z),      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      KC_LGUI,      KC_LALT,      KC_LCTL,      KC_LSFT,      XXXXXXX,                                     XXXXXXX,      KC_MS_L,      KC_MS_D,      KC_MS_U,      KC_MS_R,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               XXXXXXX,      XXXXXXX,      KC_RALT,      XXXXXXX,      XXXXXXX,      XXXXXXX,                                     XXXXXXX,      KC_WH_L,      KC_WH_D,      KC_WH_U,      KC_WH_R,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                       XXXXXXX,      XXXXXXX,      XXXXXXX,         KC_BTN1,      KC_BTN2,      KC_BTN3
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    ),

    [_GAME] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
                  KC_I,  TD(ESC_TAB),         KC_Q,         KC_W,         KC_E,         KC_R,                                     XXXXXXX,    TG(_GAME),      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
               KC_LALT,      KC_LSFT,         KC_A,         KC_S,         KC_D,         KC_F,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
                  KC_M,      KC_LCTL,         KC_Z,         KC_X,         KC_C,         KC_V,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                 MO(_GAME_FUN),       KC_SPC,MO(_GAME_NUM),         XXXXXXX,      XXXXXXX,      XXXXXXX
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    ),

    [_GAME_NUM] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
                  KC_L,       KC_EQL,         KC_7,         KC_8,         KC_9,         KC_J,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
                  KC_K,      KC_MINS,         KC_4,         KC_5,         KC_6,         KC_G,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
                  KC_O,         KC_0,         KC_1,         KC_2,         KC_3,         KC_B,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                       XXXXXXX,      XXXXXXX,      XXXXXXX,         XXXXXXX,      XXXXXXX,      XXXXXXX
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    ),

    [_GAME_FUN] = LAYOUT(
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
                  KC_T,       KC_F12,        KC_F7,        KC_F8,        KC_F9,         KC_U,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
                  KC_Y,       KC_F11,        KC_F4,        KC_F5,        KC_F6,         KC_H,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------|                              |-------------+-------------+-------------+-------------+-------------+-------------|
                  KC_P,       KC_F10,        KC_F1,        KC_F2,        KC_F3,         KC_N,                                     XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,      XXXXXXX,
//      |-------------+-------------+-------------+-------------+-------------+-------------+-------------|  |-------------+-------------+-------------+-------------+-------------+-------------+-------------|
                                                                       XXXXXXX,      XXXXXXX,      XXXXXXX,         XXXXXXX,      XXXXXXX,      XXXXXXX
//                                                              |-------------+-------------+-------------|  |-------------+-------------+-------------|
    )
};

void double_tap_boot(tap_dance_state_t *state, void *user_data) {
    if (state->count == 2) {
        reset_keyboard();
    }
}

tap_dance_action_t tap_dance_actions[] = {
    [ESC_TAB] = ACTION_TAP_DANCE_DOUBLE(KC_TAB, KC_ESC),
    [DT_BOOT] = ACTION_TAP_DANCE_FN(double_tap_boot),
};

bool caps_word_press_user(uint16_t keycode) {
    switch (keycode) {
        case KC_A ... KC_Z:
            add_weak_mods(MOD_BIT(KC_LSFT));
            return true;

        case KC_1 ... KC_0:
        case KC_BSPC:
        case KC_DEL:
        case KC_UNDS:
            return true;

        default:
            return false;
    }
}

uint16_t achordion_streak_timeout(uint16_t tap_hold_keycode) {
    if (IS_QK_LAYER_TAP(tap_hold_keycode)) {
        return 0;
    }

    return 100;
}

bool achordion_chord(uint16_t tap_hold_keycode, keyrecord_t* tap_hold_record, uint16_t other_keycode, keyrecord_t* other_record) {
    if (
        tap_hold_record->event.key.row % (MATRIX_ROWS / 2) >= 3 ||
        other_record->event.key.row % (MATRIX_ROWS / 2) >= 3
    ) {
        return true;
    }

    return achordion_opposite_hands(tap_hold_record, other_record);
}

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    if (!process_achordion(keycode, record)) {
        return false;
    }

    switch (keycode) {
        case CW_TOGG:
            if (record->event.pressed) {
                if (get_mods() & MOD_MASK_SHIFT) {
                    register_code(KC_CAPS);
                } else {
                    caps_word_toggle();
                }
            } else {
                unregister_code(KC_CAPS);
            }
            return false;

        default:
            return true;
    }
}

void matrix_scan_user(void) {
    achordion_task();
}
